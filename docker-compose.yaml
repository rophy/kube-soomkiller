services:
  # Build the image
  build:
    build:
      context: .
      dockerfile: Dockerfile
    image: kube-soomkiller:latest

  # Run tests
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
    working_dir: /app
    command: go test -v ./...

  # Lint code
  lint:
    image: golangci/golangci-lint:v1.55
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
    working_dir: /app
    command: golangci-lint run ./...

  # Local development with hot reload
  dev:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
      - ~/.kube:/root/.kube:ro
    working_dir: /app
    environment:
      - NODE_NAME=${NODE_NAME:-test-node}
      - KUBECONFIG=/root/.kube/config
    command: go run ./cmd/kube-soomkiller --dry-run -v=2

volumes:
  go-cache:
